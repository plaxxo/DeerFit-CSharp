@page "/members/edit/{Id}"
@using DeerFit.Core.Models
@using DeerFit.Core.Services
@rendermode InteractiveServer
@inject MemberService MemberService
@inject NavigationManager Nav

<HeroDots />

<div class="page-header">
    <h1>✏️ Member bearbeiten</h1>
    <button class="btn btn-secondary" @onclick='() => Nav.NavigateTo("/members")'>
        ← Zurück
    </button>
</div>

@if (_loading)
{
    <div class="loading">⏳ Lade Member...</div>
}
else if (_member is null)
{
    <div class="alert alert-error">Member nicht gefunden.</div>
}
else
{
    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="alert alert-error" style="margin: 0 80px 16px;">@_errorMessage</div>
    }
    @if (!string.IsNullOrEmpty(_successMessage))
    {
        <div class="alert alert-success" style="margin: 0 80px 16px;">@_successMessage</div>
    }

    <div class="card">
        <EditForm Model="_member" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="form-grid">
                <div class="form-group">
                    <label>Vorname *</label>
                    <InputText @bind-Value="_member.FirstName" />
                    <ValidationMessage For="() => _member.FirstName" />
                </div>
                <div class="form-group">
                    <label>Nachname *</label>
                    <InputText @bind-Value="_member.LastName" />
                    <ValidationMessage For="() => _member.LastName" />
                </div>
                <div class="form-group">
                    <label>E-Mail *</label>
                    <InputText @bind-Value="_member.Email" />
                    <ValidationMessage For="() => _member.Email" />
                </div>
                <div class="form-group">
                    <label>Telefon</label>
                    <InputText @bind-Value="_member.Phone" />
                </div>
                <div class="form-group">
                    <label>Mitgliedschaft</label>
                    <InputSelect @bind-Value="_member.Membership">
                        @foreach (var type in Enum.GetValues<MembershipType>())
                        {
                            <option value="@type">@type</option>
                        }
                    </InputSelect>
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <InputSelect @bind-Value="_member.IsActive">
                        <option value="true">Aktiv</option>
                        <option value="false">Inaktiv</option>
                    </InputSelect>
                </div>
            </div>

            <div class="form-actions">
                <button class="btn btn-primary" type="submit" disabled="@_saving">
                    @if (_saving)
                    {
                        <span>⏳ Speichern...</span>
                    }
                    else
                    {
                        <span>💾 Änderungen speichern</span>
                    }
                </button>
                <button class="btn btn-secondary" type="button" disabled="@_saving"
                        @onclick='() => Nav.NavigateTo("/members")'>
                    Abbrechen
                </button>
            </div>
        </EditForm>
    </div>
}

@code {
    [Parameter] public string Id { get; set; } = null!;

    private Member? _member;
    private bool    _loading = true;
    private bool    _saving;
    private string  _errorMessage   = string.Empty;
    private string  _successMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        _member  = await MemberService.GetByIdAsync(Id);
        _loading = false;
    }

    private async Task HandleSubmit()
    {
        if (_saving) return;

        try
        {
            _saving = true;
            _errorMessage = _successMessage = string.Empty;
            await InvokeAsync(StateHasChanged);

            var (success, message) = await MemberService.UpdateAsync(Id, _member!);

            if (success)
                _successMessage = message;
            else
                _errorMessage = message;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Fehler beim Speichern: {ex.Message}";
        }
        finally
        {
            _saving = false;
            await InvokeAsync(StateHasChanged);
        }
    }
}